<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Global Electric Vehicle Market - Narrative Visualization (D3 v3, 2 scenes)</title>
  <script src="https://d3js.org/d3.v3.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#fafafa; color:#222;}
    header { padding: 16px 20px; background: #111827; color: #fff; }
    header h1 { margin: 0; font-size: 20px; }
    header p { margin: 4px 0 0; font-size: 13px; opacity: .8; }
    #app { max-width: 1080px; margin: 20px auto 60px; padding: 0 16px; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; }
    button { padding: 8px 12px; border: 1px solid #E5E7EB; background: white; border-radius: 10px; cursor: pointer; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .pill { padding: 4px 8px; border-radius: 999px; background: #EEF2FF; color:#3730A3; font-size: 12px; }
    .scene-title { margin: 8px 0 14px; font-weight: 600; }
    .chart-wrap { background: white; border: 1px solid #E5E7EB; border-radius: 14px; padding: 14px; }
    svg { width: 100%; height: 520px; }
    .axis path, .axis line { fill: none; stroke: #D1D5DB; shape-rendering: crispEdges; }
    .axis text { fill: #374151; font-size: 11px; }
    .grid line { stroke: #F3F4F6; }
    .legend { font-size: 12px; cursor: pointer; }
    .tooltip {
      position: absolute; pointer-events: none; background: rgba(17,24,39,.95);
      color:#fff; padding: 6px 8px; border-radius: 8px; font-size: 12px; line-height: 1.3;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }
    .note { font-size: 12px; color:#6B7280; margin-top: 8px; }
    select { padding: 6px 8px; border: 1px solid #E5E7EB; border-radius: 10px; background:white; }
    .hidden { display: none; }
    .annot { fill:#111827; font-size:12px; }
  </style>
</head>
<body>
<header>
  <h1>Global Electric Vehicle Market · Narrative Visualization (D3 v3)</h1>
  <p>Structure: Slideshow · <strong>2 scenes</strong> (Global sales trend → Market share trends)</p>
</header>
<div id="app">
  <div class="controls">
    <span class="pill">Scene <span id="sceneNo">1</span>/2</span>
    <button id="prevBtn" disabled>Previous</button>
    <button id="nextBtn">Next</button>
    <label id="countryLabel" class="hidden">
      Country: <select id="countrySelect"></select>
    </label>
  </div>
  <h3 class="scene-title" id="sceneTitle">Scene 1: Global EV sales trend (with key countries)</h3>
  <div class="chart-wrap">
    <svg id="chart"></svg>
    <div class="note" id="sceneNote">Note: Highlights key years (e.g., 2020/2022/2023). Use the legend to toggle series.</div>
  </div>
</div>
<div id="tooltip" class="tooltip" style="opacity:0"></div>
<script>
var scene = 1;
var svg = d3.select("#chart");
var margin = {top: 28, right: 140, bottom: 44, left: 64};
var width = parseInt(svg.style("width")) - margin.left - margin.right;
var height = parseInt(svg.style("height")) - margin.top - margin.bottom;
var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
var x = d3.time.scale().range([0, width]);
var y = d3.scale.linear().range([height, 0]);
var xAxis = d3.svg.axis().scale(x).orient("bottom").ticks(8).tickFormat(d3.time.format('%Y'));
var yAxis = d3.svg.axis().scale(y).orient("left").ticks(6);
var tooltip = d3.select("#tooltip");
var color = d3.scale.category10();
var countrySelect = d3.select("#countrySelect");
var countryLabel = d3.select("#countryLabel");
var sceneTitle = d3.select("#sceneTitle");
var sceneNo = d3.select("#sceneNo");
var sceneNote = d3.select("#sceneNote");
var data_sales = null, data_share_long = null;
function toDate(y){ return new Date(+y, 0, 1); }
function fmt(num){ return d3.format(",")(num); }

// Load data (no policy file needed)
d3.csv("global_sales.csv", function(sales){
  d3.csv("market_share.csv", function(share){
      sales.forEach(function(d){
        d.Year = +d.Year;
        Object.keys(d).forEach(function(k){ if(k!=="Year" && d[k]!=="" && d[k]!=null) d[k]=+d[k]; });
      });
      share.forEach(function(d){ d.Year=+d.Year; d.SharePercent=+d.SharePercent; });
      data_sales = sales;
      data_share_long = share;
      renderScene1();
      updateControls();
  });
});

d3.select("#prevBtn").on("click", function(){ if(scene>1){ scene--; rerender(); }});
d3.select("#nextBtn").on("click", function(){ if(scene<2){ scene++; rerender(); }});
countrySelect.on("change", function(){ if(scene===2) renderScene2(this.value); });

function rerender(){ g.selectAll("*").remove(); renderCurrentScene(); updateControls(); }
function renderCurrentScene(){ if(scene===1) renderScene1(); else renderScene2(); }

function updateControls(){
  d3.select("#prevBtn").attr("disabled", scene===1 ? true : null);
  d3.select("#nextBtn").attr("disabled", scene===2 ? true : null);
  sceneNo.text(scene);
  if(scene===1){
    countryLabel.classed("hidden", true);
    sceneTitle.text("Scene 1: Global EV sales trend (with key countries)");
    sceneNote.text("Note: Highlights key years (e.g., 2020/2022/2023). Use the legend to toggle series.");
  }else{
    countryLabel.classed("hidden", false);
    sceneTitle.text("Scene 2: EV market share trends (%) for major countries");
    sceneNote.text("Note: Use the dropdown to highlight a country; hover for details.");
  }
}

// ------- Scene 1: Global sales + key countries -------
function renderScene1(){
  var columns = d3.keys(data_sales[0]).filter(function(k){ return k!=="Year"; });
  columns.sort(function(a,b){ if(a==="World") return -1; if(b==="World") return 1; return a.localeCompare(b); });
  var years = data_sales.map(function(d){return d.Year;});
  x.domain(d3.extent(years, function(y){ return toDate(y);}));
  var ymax = d3.max(data_sales, function(d){ var m=0; columns.forEach(function(c){ if(!isNaN(d[c])) m=Math.max(m,d[c]);}); return m; });
  y.domain([0, ymax*1.05]);
  g.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis);
  g.append("g").attr("class","y axis").call(yAxis);

  var line = d3.svg.line().x(function(d){ return x(toDate(d.Year)); }).y(function(d){ return y(d.value); }).defined(function(d){return !isNaN(d.value);});
  var visible = {}; columns.forEach(function(c,i){ visible[c]=(c==="World"||i<6); });

  var legend = g.append("g").attr("class","legend").attr("transform","translate("+(width+10)+",0)");
  var leg = legend.selectAll("g").data(columns).enter().append("g")
      .attr("transform", function(d,i){ return "translate(0,"+(i*18)+")"; })
      .on("click", function(d){ visible[d]=!visible[d]; draw(); d3.select(this).select("text").style("opacity", visible[d]?1:.4); });
  leg.append("rect").attr("x",-8).attr("y",-10).attr("width",8).attr("height",8).style("fill",function(d){return color(d);});
  leg.append("text").attr("x",4).attr("y",0).attr("dy",".35em").text(function(d){return d;});

  [2020,2022,2023,2024].forEach(function(yy){
    if(years.indexOf(yy)>=0){
      g.append("line").attr("x1", x(toDate(yy))).attr("x2", x(toDate(yy))).attr("y1",0).attr("y2",height).style("stroke","#E5E7EB").style("stroke-dasharray","4,3");
      g.append("text").attr("class","annot").attr("x", x(toDate(yy))+4).attr("y", 12).text("Key year: "+yy);
    }
  });

  function draw(){
    var series = columns.filter(function(c){ return visible[c]; }).map(function(c){
      return { name:c, values: data_sales.map(function(r){ return {Year:r.Year, value:r[c]}; }) };
    });
    var groups = g.selectAll(".series").data(series, function(d){return d.name;});
    groups.exit().remove();
    var enter = groups.enter().append("g").attr("class","series");
    var paths = groups.selectAll("path.line").data(function(d){return [d.values];});
    paths.enter().append("path").attr("class","line").style("fill","none");
    paths.transition().attr("d", line).style("stroke", function(d,i,j){ return color(series[j].name); }).style("stroke-width", function(d,i,j){ return series[j].name==="World"?3:1.8; });

    var pts = groups.selectAll("circle.pt").data(function(d){ return d.values.filter(line.defined()); });
    pts.enter().append("circle").attr("class","pt").attr("r",2.5);
    pts.transition().attr("cx", function(d){ return x(toDate(d.Year)); }).attr("cy", function(d){ return y(d.value); }).style("fill", function(d,i,j){ return color(series[j].name); });
    pts.on("mousemove", function(d,i){
      var name = d3.select(this.parentNode).datum().name;
      tooltip.style("opacity",1).html("<div><b>"+name+"</b></div><div>Year: "+d.Year+"</div><div>Sales: "+fmt(d.value)+"</div>").style("left", (d3.event.pageX+12) + "px").style("top", (d3.event.pageY-12) + "px");
    }).on("mouseout", function(){ tooltip.style("opacity",0); });
  }
  draw();
}

// ------- Scene 2: Market share trends -------
function renderScene2(focusCountry){
  var countries = d3.set(data_share_long.map(function(d){return d.Country;})).values().sort(d3.ascending);
  var sel = countrySelect.selectAll("option").data(["(All)"].concat(countries));
  sel.enter().append("option");
  countrySelect.selectAll("option").text(function(d){return d;});
  if(!focusCountry){ countrySelect.property("value", "(All)"); } else { countrySelect.property("value", focusCountry); }

  var years = d3.set(data_share_long.map(function(d){return d.Year;})).values().map(function(d){return +d;}).sort(d3.ascending);
  x.domain(d3.extent(years, function(y){ return toDate(y);}));

  var latestByCountry = d3.nest().key(function(d){ return d.Country; }).rollup(function(v){
    var last = v.sort(function(a,b){return a.Year-b.Year;})[v.length-1]; return last?last.SharePercent:0;
  }).entries(data_share_long);
  latestByCountry.sort(function(a,b){ return b.values - a.values; });
  var top = latestByCountry.slice(0,8).map(function(d){return d.key;});

  var nested = d3.nest().key(function(d){return d.Country;}).entries(data_share_long);
  if(focusCountry && focusCountry !== "(All)"){ nested = nested.filter(function(s){ return s.key===focusCountry; }); } else { nested = nested.filter(function(s){ return top.indexOf(s.key)>=0; }); }

  var ymax = d3.max(nested, function(s){ return d3.max(s.values, function(d){ return d.SharePercent; }); });
  y.domain([0, Math.max(10, ymax*1.15)]);

  g.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(xAxis);
  g.append("g").attr("class","y axis").call(yAxis);

  var line = d3.svg.line().x(function(d){ return x(toDate(d.Year)); }).y(function(d){ return y(d.SharePercent); }).defined(function(d){return !isNaN(d.SharePercent);});

  var groups = g.selectAll(".series").data(nested, function(d){return d.key;});
  groups.exit().remove();
  var enter = groups.enter().append("g").attr("class","series");
  enter.append("path").attr("class","line").style("fill","none");
  groups.select("path.line").transition().attr("d", function(d){ return line(d.values.sort(function(a,b){return a.Year-b.Year;})); }).style("stroke", function(d){ return color(d.key); }).style("stroke-width",2);

  groups.selectAll("circle.pt").remove();
  groups.each(function(s){
    d3.select(this).selectAll("circle.pt").data(s.values.filter(line.defined()))
      .enter().append("circle").attr("class","pt").attr("r",3)
      .attr("cx", function(d){ return x(toDate(d.Year)); })
      .attr("cy", function(d){ return y(d.SharePercent); })
      .style("fill", color(s.key))
      .on("mousemove", function(d){
        tooltip.style("opacity",1).html("<div><b>"+s.key+"</b></div><div>Year: "+d.Year+"</div><div>EV Share: "+d3.format('.1f')(d.SharePercent)+"%</div>").style("left", (d3.event.pageX+12)+"px").style("top", (d3.event.pageY-12)+"px");
      }).on("mouseout", function(){ tooltip.style("opacity",0); });
  });
}
</script>
</body>
</html>
